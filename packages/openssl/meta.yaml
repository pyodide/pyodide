package:
  name: openssl
  version: 3.0.1

source:
  url: https://www.openssl.org/source/openssl-3.0.1.tar.gz
  sha256: c311ad853353bce796edad01a862c50a8a587f62e7e2100ef465ab53ec9b06d1
build:
  sharedlibrary: true
  script: |
    emconfigure ./Configure gcc -no-sock -no-ui-console -DHAVE_FORK=0 -DOPENSSL_NO_SECURE_MEMORY -DNO_SYSLOG -fPIC
    sed -i 's!CROSS_COMPILE=/src/emsdk/emsdk/upstream/emscripten/em!!g' Makefile
    make build_generated
    make -j ${PYODIDE_JOBS:-3} libcrypto.a
    make -j ${PYODIDE_JOBS:-3} libssl.a
    emar -d libcrypto.a liblegacy-lib-bn_asm.o liblegacy-lib-des_enc.o liblegacy-lib-fcrypt_b.o
    mkdir dist
    emcc -sSIDE_MODULE=1 libcrypto.a -o dist/libcrypto.so
    emcc -sSIDE_MODULE=1 libssl.a -o dist/libssl.so
