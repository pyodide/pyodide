From 3f777056afeac1802badb1ed475e6e898b331327 Mon Sep 17 00:00:00 2001
From: Hood <hood@mit.edu>
Date: Fri, 2 Apr 2021 14:24:24 -0700
Subject: [PATCH] temp

---
 numpy/core/src/multiarray/conversion_utils.c |  5 ++--
 numpy/core/src/multiarray/iterators.c        | 25 +++++++++++++++-----
 2 files changed, 22 insertions(+), 8 deletions(-)

diff --git a/numpy/core/src/multiarray/conversion_utils.c b/numpy/core/src/multiarray/conversion_utils.c
index 52cb58726..5467f4d78 100644
--- a/numpy/core/src/multiarray/conversion_utils.c
+++ b/numpy/core/src/multiarray/conversion_utils.c
@@ -955,9 +955,9 @@ PyArray_IntpFromIndexSequence(PyObject *seq, npy_intp *vals, npy_intp maxvals)
                 return -1;
             }
 
-            vals[i] = PyArray_PyIntAsIntp(op);
+            npy_intp x = PyArray_PyIntAsIntp(op);
             Py_DECREF(op);
-            if(vals[i] == -1) {
+            if(x == -1) {
                 err = PyErr_Occurred();
                 if (err &&
                         PyErr_GivenExceptionMatches(err, PyExc_OverflowError)) {
@@ -968,6 +968,7 @@ PyArray_IntpFromIndexSequence(PyObject *seq, npy_intp *vals, npy_intp maxvals)
                     return -1;
                 }
             }
+            vals[i] = x;
         }
     }
     return nd;
diff --git a/numpy/core/src/multiarray/iterators.c b/numpy/core/src/multiarray/iterators.c
index 9da811f69..3e81aee91 100644
--- a/numpy/core/src/multiarray/iterators.c
+++ b/numpy/core/src/multiarray/iterators.c
@@ -1153,6 +1153,17 @@ NPY_NO_EXPORT PyTypeObject PyArrayIter_Type = {
 
 /** END of Array Iterator **/
 
+__attribute__((noinline))
+NPY_NO_EXPORT int
+PyArray_Broadcast_GetNd(PyArrayMultiIterObject *mit){
+    int i, nd;
+    /* Discover the broadcast number of dimensions */
+    for (i = 0, nd = 0; i < mit->numiter; i++) {
+        nd = PyArray_MAX(nd, PyArray_NDIM(mit->iters[i]->ao));
+    }
+    return nd;
+}
+
 /* Adjust dimensionality and strides for index object iterators
    --- i.e. broadcast
 */
@@ -1163,18 +1174,20 @@ PyArray_Broadcast(PyArrayMultiIterObject *mit)
     int i, nd, k, j;
     npy_intp tmp;
     PyArrayIterObject *it;
+    PyArrayIterObject **it_ptr;
 
-    /* Discover the broadcast number of dimensions */
-    for (i = 0, nd = 0; i < mit->numiter; i++) {
-        nd = PyArray_MAX(nd, PyArray_NDIM(mit->iters[i]->ao));
-    }
+    nd = PyArray_Broadcast_GetNd(mit);
     mit->nd = nd;
 
     /* Discover the broadcast shape in each dimension */
     for (i = 0; i < nd; i++) {
         mit->dimensions[i] = 1;
-        for (j = 0; j < mit->numiter; j++) {
-            it = mit->iters[j];
+    }
+
+    it_ptr = &mit->iters[0];
+    for (j = 0; j < mit->numiter; j++, it_ptr++) {
+        it = *it_ptr;
+        for (i = 0; i < nd; i++) {
             /* This prepends 1 to shapes not already equal to nd */
             k = i + PyArray_NDIM(it->ao) - nd;
             if (k >= 0) {
-- 
2.17.1

