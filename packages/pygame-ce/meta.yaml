package:
  name: pygame-ce
  version: 2.4.0
  top-level:
    - pygame
source:
  url: https://files.pythonhosted.org/packages/2e/94/c07e27d2c065ca493967ee1d083a3e74452339836854a56d01e3e8a98f2c/pygame-ce-2.4.0.tar.gz
  sha256: 77f541a6113f3449fd18e252a80f8d57896a7f108a4adffb084d3e6920955bda
  patches:
    - patches/0001-support-emsdk-3.1.51.patch
build:
  script: |
    export SDL_CONFIG=${WASM_LIBRARY_DIR}/bin/sdl2-config
  cflags: |
    -sRELOCATABLE=1
    -DSDL_NO_COMPAT
    -DBUILD_STATIC
    -ferror-limit=1
    -sUSE_FREETYPE=1
    -I$(WASM_LIBRARY_DIR)/include/SDL2
  ldflags: |
    -sRELOCATABLE=1
    -L$(WASM_LIBRARY_DIR)/lib
    -lSDL2
    -lSDL2_image
    -lSDL2_mixer
    -lSDL2_ttf
  post: |
    # Remove docs to reduce the size of a wheel
    # (Perhaps also remove typeshed and examples too?)
    rm -rf ./pygame/docs

    # WASM version of pygame uses a single module 'pygame_static',
    # and pygame_static calls PyInit_* functions from other modules.
    # This is okay when all these modules are bundled in a single module: libpython.
    # But since we don't do that, we need to load these modules globally, so that
    # pygame_static can see the symbols.
    STATIC_OBJ=$(find ${PKG_BUILD_DIR} -name static.o)
    echo "build dir: " $PKG_BUILD_DIR
    echo "static objs: " $STATIC_OBJ

    SHARED_LIBS=$(find ${WHEELDIR} -name "*.so" ! -name "static*.so")
    echo "shared libs: " $SHARED_LIBS

    emcc \
      -shared \
      ${SIDE_MODULE_LDFLAGS} \
      -fPIC \
      -L${WASM_LIBRARY_DIR}/lib \
      -lSDL2 \
      -lSDL2_mixer \
      -lSDL2_image \
      -lSDL2_ttf \
      ${STATIC_OBJ} \
      ${SHARED_LIBS} \
      -o pygame_static.so

    # Remove duplicated static.so module
    rm -f ./pygame/static*.so
requirements:
  host:
    - libsdl2
    - libsdl2_image
    - libsdl2_mixer
    - libsdl2_ttf
about:
  home: https://www.pygame.org
  PyPI: https://pypi.org/project/pygame
  summary: Python Game Development
  license: LGPL
