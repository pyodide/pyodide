package:
  name: pygame-ce
  version: 2.1.4
  top-level:
    - pygame
source:
  url: https://files.pythonhosted.org/packages/22/93/9e7640f46c46702641bfecd9ce0cbfb7d7366d7b638b77630006d273a45a/pygame-ce-2.1.4.tar.gz
  sha256: 17244d4ef049e053bbd14e801f1a4c2ec0a65c069a3cf6793b66c622e15077bc
build:
  script: |
    embuilder build sdl2 sdl2_ttf sdl2_mixer sdl2_image --pic
    export SDL_CONFIG=$(em-config CACHE)/sysroot/bin/sdl2-config
    export PORTS_LIBDIR=$(em-config CACHE)/sysroot/lib/wasm32-emscripten/pic/
  cflags: |
    -sRELOCATABLE=1
    -DSDL_NO_COMPAT
    -DBUILD_STATIC
    -ferror-limit=1
    -sUSE_SDL=2
    -sUSE_SDL_MIXER=2
    -sUSE_SDL_TTF=2
    -sUSE_SDL_IMAGE=2
    -sUSE_FREETYPE=1
    -sUSE_LIBJPEG=1
    -sUSE_LIBPNG=1
    -I$(WASM_LIBRARY_DIR)/include/SDL2
  ldflags: |
    -sRELOCATABLE=1
    -sUSE_SDL=2
    -sUSE_SDL_MIXER=2
    -sUSE_SDL_TTF=2
    -sUSE_SDL_IMAGE=2
    -sUSE_FREETYPE=1
    -sUSE_LIBJPEG=1
    -sUSE_LIBPNG=1
    -L$(WASM_LIBRARY_DIR)/lib
    -lSDL2
  post: |
    cd ${PKG_BUILD_DIR}

    # Remove docs to reduce the size of a wheel
    # (Perhaps also remove typeshed and examples?)
    rm -rf ${WHEELDIR}/pygame/docs

    # WASM version of pygame uses a single module 'pygame_static',
    # and pygame_static calls PyInit_* functions from other modules.
    # This is okay when all these modules are bundled in a single module: libpython.
    # But since we don't do that, we need to make load these modules globally, so that
    # pygame_static can see the symbols.
    STATIC_OBJ=$(find . -name static.o)
    echo $STATIC_OBJ

    SHARED_LIBS=$(find ${WHEELDIR} -name "*.so" ! -name "static*.so")
    echo $SHARED_LIBS

    emcc \
      -shared \
      ${SIDE_MODULE_LDFLAGS} \
      -fPIC \
      -lSDL2 \
      -lSDL2_mixer_ogg \
      -lSDL2_ttf \
      -lSDL2_image \
      -lfreetype \
      -ljpeg \
      -lpng \
      ${STATIC_OBJ} \
      ${SHARED_LIBS} \
      -o ${WHEELDIR}/pygame_static.so

    # Remove duplicated static.so module
    rm -f ${WHEELDIR}/pygame/static*.so

about:
  home: https://www.pygame.org
  PyPI: https://pypi.org/project/pygame
  summary: Python Game Development
  license: LGPL
