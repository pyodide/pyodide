package:
  name: sqlite3
  version: 1.0.0 # Nonesense
  _cpython_dynlib: true
source:
  path: empty
build:
  sharedlibrary: true
  script: |
    mkdir dist
    export DISTDIR=$(pwd)/dist
    cd $CPYTHONBUILD

    export FILES=(
      "Modules/_sqlite/cache.c"
      "Modules/_sqlite/connection.c"
      "Modules/_sqlite/cursor.c"
      "Modules/_sqlite/microprotocols.c"
      "Modules/_sqlite/module.c"
      "Modules/_sqlite/prepare_protocol.c"
      "Modules/_sqlite/row.c"
      "Modules/_sqlite/statement.c"
      "Modules/_sqlite/util.c"
    )

    for file in "${FILES[@]}"; do
      emcc $STDLIB_MODULE_CFLAGS -c "${file}" -o "${file/.c/.o}"  \
        $(pkg-config --cflags  --dont-define-prefix sqlite3) -DMODULENAME=sqlite
    done

    OBJECT_FILES=$(find Modules/_sqlite/ -name "*.o")
    emcc $OBJECT_FILES -o $DISTDIR/_sqlite3.so $SIDE_MODULE_LDFLAGS \
       $(pkg-config --libs --dont-define-prefix sqlite3)

requirements:
  run:
    - libsqlite3
test:
  imports:
    - sqlite3
