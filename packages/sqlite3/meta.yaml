package:
  name: sqlite3
  version: 1.0.0 # Nonsense
  tag:
    - always
  top-level:
    - sqlite3
    - _sqlite3
source:
  path: src
build:
  type: cpython_module
  script: |
    wget ${PYTHON_ARCHIVE_URL} -O Python-${PYVERSION}.tgz
    tar -xf Python-${PYVERSION}.tgz
    cd Python-${PYVERSION}

    export FILES=(
      "Modules/_sqlite/blob.c"
      "Modules/_sqlite/connection.c"
      "Modules/_sqlite/cursor.c"
      "Modules/_sqlite/microprotocols.c"
      "Modules/_sqlite/module.c"
      "Modules/_sqlite/prepare_protocol.c"
      "Modules/_sqlite/row.c"
      "Modules/_sqlite/statement.c"
      "Modules/_sqlite/util.c"
    )

    export SQLITE_WASM_VERSION=3450300
    export SQLITE_WASM_YEAR=2024
    wget -O sqlite.zip https://www.sqlite.org/${SQLITE_WASM_YEAR}/sqlite-src-${SQLITE_WASM_VERSION}.zip
    unzip -q -o sqlite.zip -d sqlite
    (cd sqlite/sqlite-src-${SQLITE_WASM_VERSION}/ && ./configure --enable-all && make sqlite3.c)
    export SQLITE_FLAGS="\
      -DSTDC_HEADERS=1 \
      -DHAVE_SYS_TYPES_H=1 \
      -DHAVE_SYS_STAT_H=1 \
      -DHAVE_STDLIB_H=1 \
      -DHAVE_STRING_H=1 \
      -DHAVE_MEMORY_H=1 \
      -DHAVE_STRINGS_H=1 \
      -DHAVE_INTTYPES_H=1 \
      -DHAVE_STDINT_H=1 \
      -DHAVE_UNISTD_H=1 \
      -DHAVE_FDATASYNC=1 \
      -DHAVE_USLEEP=1 \
      -DHAVE_LOCALTIME_R=1 \
      -DHAVE_GMTIME_R=1 \
      -DHAVE_DECL_STRERROR_R=1 \
      -DHAVE_STRERROR_R=1 \
      -DHAVE_POSIX_FALLOCATE=1 \
      -DSQLITE_ENABLE_MATH_FUNCTIONS=1 \
      -DSQLITE_ENABLE_FTS4=1 \
      -DSQLITE_ENABLE_FTS5=1 \
      -DSQLITE_ENABLE_RTREE=1 \
      -DSQLITE_ENABLE_GEOPOLY=1 \
      -DSQLITE_OMIT_POPEN=1 \
      -DSQLITE_THREADSAFE=0 \
      -DSQLITE_CORE"

    emcc -c sqlite/sqlite-src-${SQLITE_WASM_VERSION}/sqlite3.c -o sqlite3.c.o -g3 -fPIC

    for file in "${FILES[@]}"; do
      emcc $STDLIB_MODULE_CFLAGS -c "${file}" -o "${file/.c/.o}"  \
        -sUSE_SQLITE3 -DMODULENAME=sqlite
    done

    OBJECT_FILES=$(find Modules/_sqlite/ -name "*.o")
    emcc $OBJECT_FILES sqlite3.c.o -o ${PKG_BUILD_DIR}/_sqlite3.so $SIDE_MODULE_LDFLAGS \
       -sUSE_SQLITE3 

    cd Lib && tar --exclude=test -cf - sqlite3 | tar -C ${PKG_BUILD_DIR} -xf -
about:
  license: PSF
