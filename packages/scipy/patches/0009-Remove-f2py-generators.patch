From 9b670bd5330bd7834d157a9ec3087a97b71d6516 Mon Sep 17 00:00:00 2001
From: Agriya Khetarpal <74401230+agriyakhetarpal@users.noreply.github.com>
Date: Fri, 16 Aug 2024 22:59:26 +0530
Subject: [PATCH 09/12] Remove f2py generators
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

This patch reverts changes made in d85ba6b910ea9040b6a72bdc4ea87d151118f41d
and is applied at the end, after the rest of the patches â€“ the order is important.

It removes the f2py generator and replaces it with custom targets mapping to
f2py-generated wrappers. This is done to avoid the need for the f2py executable
to be present in the environment where SciPy is built. Instead, the Python
executable is used to run f2py as a module which is useful where f2py is not
present on PATH.

---
 scipy/interpolate/meson.build |  8 +++++++-
 scipy/meson.build             | 23 -----------------------
 2 files changed, 7 insertions(+), 24 deletions(-)

diff --git a/scipy/interpolate/meson.build b/scipy/interpolate/meson.build
index 33783fc034..7201533ef6 100644
--- a/scipy/interpolate/meson.build
+++ b/scipy/interpolate/meson.build
@@ -168,8 +168,14 @@ if use_ilp64
    extra_f2py_arg = f2py_ilp64_opts[0] + '=' + fs.parent(f2c_map_file) / fs.name(f2c_map_file)
 endif
 
+dfitpack_module = custom_target('dfitpack_module',
+  output: ['_dfitpack-f2pywrappers.f', '_dfitpackmodule.c'],
+  input: 'src/dfitpack.pyf',
+  command: [generate_f2pymod, '@INPUT@', '-o', '@OUTDIR@']
+)
+
 py3.extension_module('_dfitpack',
-  f2py_gen.process('src/dfitpack.pyf', extra_args: extra_f2py_arg),
+  dfitpack_module,
   c_args: [Wno_unused_variable] +  c_flags_ilp64,
   link_args: version_link_args,
   dependencies: [fortranobject_dep],
diff --git a/scipy/meson.build b/scipy/meson.build
index 394c6b4833..cfbfb35a73 100644
--- a/scipy/meson.build
+++ b/scipy/meson.build
@@ -201,29 +201,6 @@ fortranobject_dep = declare_dependency(
   compile_args: _f2py_c_args,
 )
 
-f2py = find_program('f2py')
-# It should be quite rare for the `f2py` executable to not be the one from
-# `numpy` installed in the Python env we are building for (unless we are
-# cross-compiling). If it is from a different env, that is still fine as long
-# as it's not too old. We are only using f2py as a code generator, and the
-# output is not dependent on platform or Python version (see gh-20612 for more
-# details).
-# This should be robust enough. If not, we can make this more complex, using
-# a fallback to `python -m f2py` rather than erroring out.
-f2py_version = run_command([f2py, '-v'], check: true).stdout().strip()
-if f2py_version.version_compare('<'+min_numpy_version)
-  error(f'Found f2py executable is too old: @f2py_version@')
-endif
-
-# Note: this generator cannot handle:
-# 1. `.pyf.src` files, because `@BASENAME@` will still include .pyf
-# 2. targets with #include's (due to no `depend_files` - see feature request
-#    at meson#8295)
-f2py_gen = generator(generate_f2pymod,
-  arguments : ['@INPUT@', '-o', '@BUILD_DIR@', '@EXTRA_ARGS@'] + f2py_freethreading_arg,
-  output : ['_@BASENAME@module.c', '_@BASENAME@-f2pywrappers.f'],
-)
-
 
 # Start of BLAS/LAPACK detection
 
-- 
2.39.3 (Apple Git-146)

