From 00fae8e00bd93a92e414303e2ce411fc0e01d004 Mon Sep 17 00:00:00 2001
From: ryanking13 <def6488@gmail.com>
Date: Tue, 27 Dec 2022 07:51:54 +0000
Subject: [PATCH 1/1] Patches from josephrocca

---
 Cargo.toml                              | 3 ++-
 src/lib.rs                              | 2 +-
 src/tokenizer.rs                        | 1 +
 src/utils/regex.rs                      | 2 +-
 tokenizers-lib/src/utils/parallelism.rs | 2 +-
 5 files changed, 6 insertions(+), 4 deletions(-)

diff --git a/Cargo.toml b/Cargo.toml
index 36cb566..70f76ff 100644
--- a/Cargo.toml
+++ b/Cargo.toml
@@ -17,12 +17,13 @@ env_logger = "0.7.1"
 pyo3 = "0.17.2"
 numpy = "0.17.2"
 ndarray = "0.13"
-onig = { version = "6.0", default-features = false }
 itertools = "0.9"
 
 [dependencies.tokenizers]
 version = "*"
 path = "./tokenizers-lib"
+default-features = false
+features = ["unstable_wasm"]
 
 [dev-dependencies]
 tempfile = "3.1"
diff --git a/src/lib.rs b/src/lib.rs
index bf1adbd..69337df 100644
--- a/src/lib.rs
+++ b/src/lib.rs
@@ -49,7 +49,7 @@ pub fn tokenizers(_py: Python, m: &PyModule) -> PyResult<()> {
     let _ = env_logger::try_init_from_env("TOKENIZERS_LOG");
 
     // Register the fork callback
-    #[cfg(target_family = "unix")]
+    #[cfg(all(target_family = "unix", not(target_family = "wasm")))]
     unsafe {
         if !REGISTERED_FORK_CALLBACK {
             libc::pthread_atfork(None, None, Some(child_after_fork));
diff --git a/src/tokenizer.rs b/src/tokenizer.rs
index 3a5a8e6..fd3feda 100644
--- a/src/tokenizer.rs
+++ b/src/tokenizer.rs
@@ -561,6 +561,7 @@ impl PyTokenizer {
     ///
     /// Returns:
     ///     :class:`~tokenizers.Tokenizer`: The new tokenizer
+    #[cfg(not(target_family = "wasm"))]
     #[staticmethod]
     #[args(revision = "String::from(\"main\")", auth_token = "None")]
     #[pyo3(text_signature = "(identifier, revision=\"main\", auth_token=None)")]
diff --git a/src/utils/regex.rs b/src/utils/regex.rs
index 9e0d424..b553415 100644
--- a/src/utils/regex.rs
+++ b/src/utils/regex.rs
@@ -1,4 +1,4 @@
-use onig::Regex;
+use tk::utils::SysRegex as Regex;
 use pyo3::exceptions;
 use pyo3::prelude::*;
 
diff --git a/tokenizers-lib/src/utils/parallelism.rs b/tokenizers-lib/src/utils/parallelism.rs
index f2de5ae..720c0cf 100644
--- a/tokenizers-lib/src/utils/parallelism.rs
+++ b/tokenizers-lib/src/utils/parallelism.rs
@@ -28,7 +28,7 @@ pub fn get_parallelism() -> bool {
             v.make_ascii_lowercase();
             !matches!(v.as_ref(), "" | "off" | "false" | "f" | "no" | "n" | "0")
         }
-        Err(_) => true, // If we couldn't get the variable, we use the default
+        Err(_) => false, // If we couldn't get the variable, we use the default
     }
 }
 
-- 
2.25.1

