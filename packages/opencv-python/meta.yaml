package:
  name: opencv-python
  version: 4.5.5.64
about:
  home: https://github.com/skvark/opencv-python
  PyPI: https://pypi.org/project/opencv-python
  summary: Wrapper package for OpenCV python bindings.
  license: MIT
source:
  url: https://files.pythonhosted.org/packages/3c/61/ee4496192ed27f657532fdf0d814b05b9787e7fc5122ed3ca57282bae69c/opencv-python-4.5.5.64.tar.gz
  sha256: f65de0446a330c3b773cd04ba10345d8ce1b15dcac3f49770204e37602d0b3f7
  extras:
    - [cmake/OpenCVFindLibsGrfmt.cmake, opencv/cmake/OpenCVFindLibsGrfmt.cmake]
    - [
        cmake/detect_ffmpeg.cmake,
        opencv/modules/videoio/cmake/detect_ffmpeg.cmake,
      ]
  patches:
    - patches/0001-Enable-file-system.patch

requirements:
  run:
    - numpy
    - ffmpeg
build:
  cxxflags: |
    -fPIC
    -s USE_ZLIB=1
    -s USE_LIBJPEG=1
    -s USE_LIBPNG=1
    -s SIDE_MODULE=1
  ldflags: |
    -ljpeg
    -lz
    -lpng

  # Note on CMAKE_ARGS:
  #   CMake args are adopted from OpenCV.js (https://github.com/opencv/opencv/blob/4.x/platforms/js/build_js.py)
  #   But we support more of modules than OpenCV.js.
  #
  # Note on CMAKE_TOOLCHAIN_FILE:
  #   We don't want to use toolchain file provided by Emscripten,
  #   because our build script hijack gcc, c++, ... and replace it with emcc, em++, ..., instead of calling them directly.
  #
  # List of OpenCV modules can be found at: https://docs.opencv.org/4.x/
  # Build configs can be found at: https://docs.opencv.org/4.x/db/d05/tutorial_config_reference.html

  script: |
    pip install scikit-build

    export VERBOSE=1
    export NUMPY_INCLUDE_DIR="$HOSTINSTALLDIR/lib/python$PYMAJOR.$PYMINOR/site-packages/numpy/core/include/"
    export EMSCRIPTEN="$PYODIDE_ROOT/emsdk/emsdk/upstream/emscripten/"
    export FFMPEG_ROOT="$PYODIDE_ROOT/packages/ffmpeg/build/ffmpeg-4.4.1/lib"

    export CMAKE_ARGS=" \
    -DCMAKE_TOOLCHAIN_FILE=$PYODIDE_ROOT/packages/opencv-python/cmake/Config.cmake \
    -DPYTHON3_INCLUDE_PATH=$PYTHONINCLUDE \
    -DPYTHON3_LIBRARY=$PYTHONINCLUDE/../libpython$PYMAJOR.$PYMINOR.a \
    -DPYTHON3_VERSION_MAJOR=$PYMAJOR \
    -DPYTHON3_VERSION_MINOR=$PYMINOR \
    -DPYTHON3_NUMPY_INCLUDE_DIRS=$NUMPY_INCLUDE_DIR \
    \
    -DWITH_ADE=ON \
    -DWITH_JPEG=ON \
    -DWITH_PNG=ON \
    -DWITH_WEBP=ON \
    \
    -DBUILD_opencv_python3=ON \
    -DBUILD_opencv_world=ON \
    -DBUILD_opencv_imgcodecs=ON \
    -DBUILD_opencv_videoio=ON \
    -DBUILD_opencv_gapi=ON \
    -DBUILD_opencv_photo=ON \
    -DBUILD_opencv_stitching=ON \
    -DBUILD_opencv_highgui=ON \
    -DBUILD_opencv_features2d=ON \
    -DBUILD_opencv_flann=ON \
    -DBUILD_opencv_calib3d=ON \
    -DBUILD_opencv_dnn=ON \
    -DBUILD_opencv_ml=ON \
    -DBUILD_opencv_objdetect=ON \
    -DWITH_OPENCL=OFF \
    -DOPENCV_DNN_OPENCL=OFF \
    -DWITH_PROTOBUF=ON \
    -DWITH_FFMPEG=ON \
    \
    -DPYTHON3_EXECUTABLE=python \
    -DPYTHON3_LIMITED_API=ON \
    -DPYTHON_DEFAULT_EXECUTABLE=python \
    -DENABLE_PIC=FALSE \
    -DCMAKE_BUILD_TYPE=Release \
    -DCPU_BASELINE='' \
    -DCPU_DISPATCH='' \
    -DCV_TRACE=OFF \
    -DBUILD_SHARED_LIBS=OFF \
    -DWITH_1394=OFF \
    -DWITH_VTK=OFF \
    -DWITH_EIGEN=OFF \
    -DWITH_GSTREAMER=OFF \
    -DWITH_GTK=OFF \
    -DWITH_GTK_2_X=OFF \
    -DWITH_QT=OFF \
    -DWITH_IPP=OFF \
    -DWITH_JASPER=OFF \
    -DWITH_OPENJPEG=OFF \
    -DWITH_OPENEXR=OFF \
    -DWITH_OPENGL=OFF \
    -DWITH_OPENVX=OFF \
    -DWITH_OPENNI=OFF \
    -DWITH_OPENNI2=OFF \
    -DWITH_TBB=OFF \
    -DWITH_TIFF=OFF \
    -DWITH_V4L=OFF \
    -DWITH_OPENCL_SVM=OFF \
    -DWITH_OPENCLAMDFFT=OFF \
    -DWITH_OPENCLAMDBLAS=OFF \
    -DWITH_GPHOTO2=OFF \
    -DWITH_LAPACK=OFF \
    -DWITH_ITT=OFF \
    -DWITH_QUIRC=OFF \
    -DBUILD_ZLIB=OFF \
    -DBUILD_opencv_apps=OFF \
    -DBUILD_opencv_shape=OFF \
    -DBUILD_opencv_videostab=OFF \
    -DBUILD_opencv_superres=OFF \
    -DBUILD_opencv_java=OFF \
    -DBUILD_opencv_js=OFF \
    -DBUILD_opencv_python2=OFF \
    -DBUILD_EXAMPLES=OFF \
    -DBUILD_PACKAGE=OFF \
    -DBUILD_TESTS=OFF \
    -DBUILD_PERF_TESTS=OFF \
    -DBUILD_DOCS=OFF \
    -DWITH_PTHREADS_PF=OFF \
    -DCV_ENABLE_INTRINSICS=OFF \
    -DBUILD_WASM_INTRIN_TESTS=OFF \
    -DCMAKE_INSTALL_PREFIX=../cmake-install \
    -DCMAKE_VERBOSE_MAKEFILE=ON \
    "

test:
  imports:
    - cv2
