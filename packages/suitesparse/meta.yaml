package:
  name: suitesparse
  version: 5.11.0

source:
  sha256: fdd957ed06019465f7de73ce931afaf5d40e96e14ae57d91f60868b8c123c4c8
  url: https://github.com/DrTimothyAldenDavis/SuiteSparse/archive/refs/tags/v5.11.0.tar.gz
  patches:
    - patches/0001-Changed-a-few-files.patch

requirements:
  run:
    - CLAPACK

build:
  sharedlibrary: true
  script: |
    sed -i '1s;^;set(CMAKE_C_COMPILER_FORCED TRUE)\nset(CMAKE_CXX_COMPILER_FORCED TRUE)\n;' metis-5.1.0/CMakeLists.txt
    ls $PYODIDE_ROOT/packages/CLAPACK/dist/lib
    emmake make -j ${PYODIDE_JOBS:-3} install \
      LDFLAGS="-sSIDE_MODULE=1 -L${WASM_LIBRARY_DIR}/lib " \
      BLAS="$PYODIDE_ROOT/packages/CLAPACK/dist/lib/clapack_all.so" \
      LAPACK="$PYODIDE_ROOT/packages/CLAPACK/dist/lib/clapack_all.so" \
      INSTALL=${WASM_LIBRARY_DIR}
    mkdir -p dist
    cp ${WASM_LIBRARY_DIR}/lib/libspqr.so.2.1.0 dist/libspqr.so
    cp ${WASM_LIBRARY_DIR}/lib/libamd.so.2.4.6 dist/libamd.so
    cp ${WASM_LIBRARY_DIR}/lib/libcamd.so.2.4.6 dist/libcamd.so
    cp ${WASM_LIBRARY_DIR}/lib/libcholmod.so.3.0.14 dist/libcholmod.so
    cp ${WASM_LIBRARY_DIR}/lib/libccolamd.so.2.9.6 dist/libccolamd.so
    cp ${WASM_LIBRARY_DIR}/lib/libcolamd.so.2.9.6 dist/libcolamd.so
    cp ${WASM_LIBRARY_DIR}/lib/libsuitesparseconfig.so.5.11.0 dist/libsuitesparseconfig.so
    cp ${WASM_LIBRARY_DIR}/lib/libmetis.so dist/libmetis.so
