package:
  name: openblas
  version: 0.3.22

source:
  # sha256: 148a959b61ffa4d77e810ceb3114765501d70c982cbb302a00954b81bc918e46
  # url: https://github.com/xianyi/OpenBLAS/archive/de4d5646eb1ac6a0e663a4c9bc797dad8226aedb.zip
  sha256: 7fa9685926ba4f27cfe513adbf9af64d6b6b63f9dcabb37baefad6a65ff347a7
  url: https://github.com/xianyi/OpenBLAS/releases/download/v0.3.22/OpenBLAS-0.3.22.tar.gz
  patches:
    - patches/0001-Add-Wno-implicit-function-declaration-flag.patch

build:
  type: shared_library
  script: |
    # seems like .zip does not maintain executable flags, need to reset these
    chmod u+x c_check
    chmod u+x f_check
    chmod u+x exports/gensymbol
    # Replace void returns by int returns
    sed -ri 's/void(\s+)BLASFUNC/int\1BLASFUNC/g' common_interface.h
    sed -ri 's/void(\s+)cblas_/int\1cblas_/g' cblas.h ctest/*.c
    sed -ri 's/void(\s+)(C?NAME)/int\1\2/g' interface/*.c
    sed -ri 's/((extern)?.+) (void|VOID) ([a-z0-9]+_)/\1\2 int \4/g' lapack-netlib/SRC/*.c lapack-netlib/SRC/DEPRECATED/*.c

    # BUILD_TESTING=OFF is a cmake thing not sure how to use it. This would avoid noisy signature mismatch
    make libs shared CC=emcc HOSTCC=gcc TARGET=RISCV64_GENERIC NOFORTRAN=1 NO_LAPACKE=1 USE_THREAD=0 LDFLAGS="${SIDE_MODULE_LDFLAGS}"
    mkdir -p dist
    cp libopenblas.so dist/
    mkdir -p ${WASM_LIBRARY_DIR}/{lib,include}
    # TODO not sure which .h are needed, copying all of them for now
    # TODO I don't think relapack is needed but maybe it has a .h I need which is why I added it???
    cp *.h relapack/src/*.h ${WASM_LIBRARY_DIR}/include
    cp dist/libopenblas.so ${WASM_LIBRARY_DIR}/lib
