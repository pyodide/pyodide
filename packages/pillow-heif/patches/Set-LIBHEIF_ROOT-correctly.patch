From 2d2c71ab35ff5f729c77e69f0f3757ff2c8621f8 Mon Sep 17 00:00:00 2001
From: Agriya Khetarpal <74401230+agriyakhetarpal@users.noreply.github.com>
Date: Sat, 9 Nov 2024 04:01:56 +0530
Subject: [PATCH] Set LIBHEIF_ROOT correctly

---
 libheif/{ => include}/heif.h | 0
 pillow_heif/_pillow_heif.c   | 2 +-
 setup.py                     | 6 ++++++
 3 files changed, 7 insertions(+), 1 deletion(-)
 rename libheif/{ => include}/heif.h (100%)

diff --git a/libheif/heif.h b/libheif/include/heif.h
similarity index 100%
rename from libheif/heif.h
rename to libheif/include/heif.h
diff --git a/pillow_heif/_pillow_heif.c b/pillow_heif/_pillow_heif.c
index f5722f1..f5275fc 100644
--- a/pillow_heif/_pillow_heif.c
+++ b/pillow_heif/_pillow_heif.c
@@ -1,7 +1,7 @@
 #define PY_SSIZE_T_CLEAN
 
 #include "Python.h"
-#include "libheif/heif.h"
+#include "heif.h"
 #include "_ph_postprocess.h"
 
 /* =========== Common stuff ======== */
diff --git a/setup.py b/setup.py
index 68945e4..7ea6154 100644
--- a/setup.py
+++ b/setup.py
@@ -205,6 +205,12 @@ class PillowHeifBuildExt(build_ext):
             self._add_directory(library_dirs, "/usr/lib64")
             self._add_directory(library_dirs, "/usr/lib")
             self._add_directory(library_dirs, "/lib")
+            # Set LIBHEIF_ROOT to libheif/ in the source tree here so that it
+            # finds the header file libheif/include/heif.h (we moved it to libheif/include/).
+            # Set LIBHEIF_ROOT from user or use the default location which is the libheif directory in the source tree.
+            LIBHEIF_ROOT = os.getenv("LIBHEIF_ROOT", os.path.join(os.path.dirname(__file__), "libheif"))
+            self._add_directory(include_dirs, os.path.join(LIBHEIF_ROOT, "include"))
+            self._add_directory(library_dirs, os.path.join(LIBHEIF_ROOT, "lib"))
 
             self._update_extension("_pillow_heif", ["heif"], extra_compile_args=["-O3", "-Werror"])
 
-- 
2.39.3 (Apple Git-146)

