From 742a3e60bdc06d650e7a641fa31aae14216bcc29 Mon Sep 17 00:00:00 2001
From: Gyeongjae Choi <def6488@gmail.com>
Date: Thu, 1 May 2025 10:37:32 +0000
Subject: [PATCH 5/5] Fix nested dependencies handling in rpath

https://github.com/emscripten-core/emscripten/pull/24234

---
 src/lib/libdylink.js |  5 ++++-
 test/test_other.py   | 19 ++++++++++++++++---
 2 files changed, 20 insertions(+), 4 deletions(-)

diff --git a/src/lib/libdylink.js b/src/lib/libdylink.js
index b1e701782..f5931218f 100644
--- a/src/lib/libdylink.js
+++ b/src/lib/libdylink.js
@@ -904,7 +904,8 @@ var LibraryDylink = {
     // We need to set rpath in flags based on the current library's rpath.
     // We can't mutate flags or else if a depends on b and c and b depends on d,
     // then c will be loaded with b's rpath instead of a's.
-    flags = {...flags, rpath: { parentLibPath: libName, paths: metadata.runtimePaths }}
+    var dso = LDSO.loadedLibsByName[libName];
+    flags = {...flags, rpath: { parentLibPath: dso.path, paths: metadata.runtimePaths }}
     // now load needed libraries and the module itself.
     if (flags.loadAsync) {
       return metadata.neededDynlibs
@@ -937,6 +938,7 @@ var LibraryDylink = {
     var dso = {
       refcount: Infinity,
       name,
+      path: name, // full path to the library, updated when the library is resolved in the filesystem.
       exports: syms,
       global: true,
     };
@@ -1105,6 +1107,7 @@ var LibraryDylink = {
 #endif
       if (f) {
         var libData = FS.readFile(f, {encoding: 'binary'});
+        dso.path = f;
         return flags.loadAsync ? Promise.resolve(libData) : libData;
       }
 #endif
-- 
2.48.1

