From 915b63517ae4b128fa5507a70dc6aa96d18e4f8b Mon Sep 17 00:00:00 2001
From: Hood <hood@mit.edu>
Date: Sat, 17 Jul 2021 16:54:40 -0700
Subject: [PATCH 01/11] Fix pipe close operation so that it doesn't break the
 other side of the pipe

---
 upstream/emscripten/src/library_pipefs.js      |  8 +++--
 tests/other/test_fd_pipe.c | 73 ++++++++++++++++++++++++++++++++++++++
 2 files changed, 79 insertions(+), 2 deletions(-)
 create mode 100644 tests/other/test_fd_pipe.c

diff --git a/src/library_pipefs.js b/src/library_pipefs.js
index c1a92ff135f..e9f661ab946 100644
--- a/emsdk/upstream/emscripten/src/library_pipefs.js
+++ b/emsdk/upstream/emscripten/src/library_pipefs.js
@@ -18,7 +18,8 @@ mergeInto(LibraryManager.library, {
     },
     createPipe: function () {
       var pipe = {
-        buckets: []
+        buckets: [],
+        closed_ends : 0,
       };
 
       pipe.buckets.push({
@@ -215,7 +216,10 @@ mergeInto(LibraryManager.library, {
       },
       close: function (stream) {
         var pipe = stream.node.pipe;
-        pipe.buckets = null;
+        pipe.closed_ends ++;
+        if(pipe.closed_ends === 2){
+          pipe.buckets = null;
+        }
       }
     },
     nextname: function () {
