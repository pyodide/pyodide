From c371fb11a1c5b557557b2681a9b6be4cdaa78644 Mon Sep 17 00:00:00 2001
From: ryanking13 <def6488@gmail.com>
Date: Fri, 30 May 2025 15:54:17 +0900
Subject: [PATCH 2/3] [dylink] Fix rpath calculation in nested dependencies

Upstream PR:
* https://github.com/emscripten-core/emscripten/pull/24234

---
 src/lib/libdylink.js | 14 ++++++++++----
 1 file changed, 10 insertions(+), 4 deletions(-)

diff --git a/src/lib/libdylink.js b/src/lib/libdylink.js
index 50020af24..7d26a28b3 100644
--- a/src/lib/libdylink.js
+++ b/src/lib/libdylink.js
@@ -972,14 +972,20 @@ var LibraryDylink = {
     // now load needed libraries and the module itself.
     if (flags.loadAsync) {
       return metadata.neededDynlibs
-        .reduce((chain, dynNeeded) => chain.then(() =>
-          loadDynamicLibrary(dynNeeded, flags, localScope)
-        ), Promise.resolve())
+        .reduce((chain, needed) => chain.then(() => {
+#if FILESYSTEM
+          needed = findLibraryFS(needed, flags.rpath) ?? needed;
+#endif
+          return loadDynamicLibrary(needed, flags, localScope);
+        }), Promise.resolve())
         .then(loadModule);
     }
 
     for (var needed of metadata.neededDynlibs) {
-      loadDynamicLibrary(needed, flags, localScope)
+#if FILESYSTEM
+      needed = findLibraryFS(needed, flags.rpath) ?? needed;
+#endif      
+      return loadDynamicLibrary(needed, flags, localScope);
     }
     return loadModule();
   },
-- 
2.43.0