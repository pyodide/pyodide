From 03a31e67f42161ed920e9a8a00094ce2d49fd667 Mon Sep 17 00:00:00 2001
From: Sam Clegg <sbc@chromium.org>
Date: Mon, 23 May 2022 15:25:21 -0700
Subject: [PATCH 5/8] Fix version reported by uname (#17026)

Fixes: #16977
---
 system/lib/libc/emscripten_syscall_stubs.c | 10 +++++++++-
 tests/core/test_uname.out                  |  2 +-
 tests/test_core.py                         |  2 +-
 3 files changed, 11 insertions(+), 3 deletions(-)

diff --git a/system/lib/libc/emscripten_syscall_stubs.c b/system/lib/libc/emscripten_syscall_stubs.c
index 0a59d1a3d..68b1a2f11 100644
--- a/system/lib/libc/emscripten_syscall_stubs.c
+++ b/system/lib/libc/emscripten_syscall_stubs.c
@@ -22,6 +22,7 @@
 #include <time.h>
 #include <sys/utsname.h>
 #include <emscripten/console.h>
+#include <emscripten/version.h>
 
 static int g_pid = 42;
 static int g_pgid = 42;
@@ -42,15 +43,22 @@ static mode_t g_umask = S_IRWXU | S_IRWXG | S_IRWXO;
     return -ENOSYS; \
   }
 
+#define STRINGIFY(s) #s
+#define STR(s) STRINGIFY(s)
+
 long __syscall_uname(long buf) {
   if (!buf) {
     return -EFAULT;
   }
+  const char* full_version = STR(__EMSCRIPTEN_major__) "." \
+                             STR(__EMSCRIPTEN_minor__) "." \
+                             STR(__EMSCRIPTEN_tiny__);
+
   struct utsname *utsname = (struct utsname *)buf;
 
   strcpy(utsname->sysname, "Emscripten");
   strcpy(utsname->nodename, "emscripten");
-  strcpy(utsname->release, "1.0");
+  strcpy(utsname->release, full_version);
   strcpy(utsname->version, "#1");
 #ifdef __wams64__
   strcpy(utsname->machine, "wasm64");
diff --git a/tests/core/test_uname.out b/tests/core/test_uname.out
index 879d445a3..3806f84db 100644
--- a/tests/core/test_uname.out
+++ b/tests/core/test_uname.out
@@ -1,6 +1,6 @@
 ret: 0
 sysname: Emscripten
 nodename: emscripten
-release: 1.0
+release: \d+.\d+.\d+
 version: #1
 machine: wasm32
diff --git a/tests/test_core.py b/tests/test_core.py
index c334c8398..5800b6a72 100644
--- a/tests/test_core.py
+++ b/tests/test_core.py
@@ -5773,7 +5773,7 @@ Module['onRuntimeInitialized'] = function() {
     self.do_core_test('test_posixtime.c')
 
   def test_uname(self):
-    self.do_core_test('test_uname.c')
+    self.do_core_test('test_uname.c', regex=True)
 
   def test_unary_literal(self):
     self.do_core_test('test_unary_literal.cpp')
-- 
2.25.1

