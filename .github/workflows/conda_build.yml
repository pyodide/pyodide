name: conda-build

on:
  workflow_dispatch:
  push:
    branches:
      - main

concurrency:
  group: ${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  build-core:
    uses: ./.github/workflows/reusable_conda_build.yml
    with:
      packages: core
      artifacts-prefix-prev: ""
      artifacts-prefix: core
      retention-days: 30

  build-packages:
    needs: [build-core]
    uses: ./.github/workflows/reusable_conda_build.yml
    with:
      packages: "*"
      artifacts-prefix-prev: core
      artifacts-prefix: packages
      retention-days: 30

  test-core:
    strategy:
      matrix:
        runner: [playwright]
        runtime: [chrome-no-host, firefox-no-host]
      fail-fast: false
    needs: [build-core]
    uses: ./.github/workflows/reusable_conda_test.yml
    with:
      runner: ${{ matrix.runner }}
      runtime: ${{ matrix.runtime }}
      test-params: -k "not webworker" src packages/micropip  packages/fpcast-test packages/sharedlib-test-py/ packages/cpp-exceptions-test/ --skip-passed
      artifacts-prefix-build: core

  test-core-webworker:
    strategy:
      matrix:
        runner: [playwright]
        runtime: [chrome-no-host, firefox-no-host]
      fail-fast: false
    needs: [build-core]
    uses: ./.github/workflows/reusable_conda_test.yml
    with:
      runner: ${{ matrix.runner }}
      runtime: ${{ matrix.runtime }}
      test-params: src/tests/test_webworker.py --skip-passed
      artifacts-prefix-build: core

  test-packages:
    strategy:
      matrix:
        runner: [playwright]
        runtime: [chrome-no-host, firefox-no-host]
      fail-fast: false
    needs: [build-packages]
    uses: ./.github/workflows/reusable_conda_test.yml
    with:
      runner: ${{ matrix.runner }}
      runtime: ${{ matrix.runtime }}
      test-params: packages/*/test*.py --skip-passed
      artifacts-prefix-build: packages
