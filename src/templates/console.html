<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <script src="https://code.jquery.com/jquery-latest.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery.terminal/js/jquery.terminal.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/jquery.terminal/css/jquery.terminal.min.css" rel="stylesheet"/>
    <link href="renderedhtml.css" rel="stylesheet"/>
    <script type="text/javascript">
        // set the pyodide files URL (packages.json, pyodide.asm.data etc)
        window.languagePluginUrl = '{{ PYODIDE_BASE_URL }}';
    </script>
    <script src="{{ PYODIDE_BASE_URL }}pyodide.js"></script>
    <style>
      .terminal { --size: 1.5; }
    </style>
  </head>
  <body>
    <script>
      languagePluginLoader.then(() => {
        pyodide.runPython(`
            import sys
            import builtins
            import js
            from reprlib import Repr
            from pyodide.console import InteractiveConsole


            # limiting output size to 1000 to avoid console hang
            _repr = Repr()
            _repr.maxdict = _repr.maxlist = _repr.maxtuple = _repr.maxset = _repr.maxfrozenset = _repr.maxdeque = _repr.maxarray = _repr.maxlong = _repr.maxstring = _repr.maxother = 10 ** 3

            def displayhook(value):
                # from https://docs.python.org/3/library/sys.html#sys.displayhook
                if value is None:
                    return
                builtins._ = None
                text = _repr.repr(value)
                try:
                    sys.stdout.write(text)
                except UnicodeEncodeError:
                    bytes = text.encode(sys.stdout.encoding, 'backslashreplace')
                    if hasattr(sys.stdout, 'buffer'):
                        sys.stdout.buffer.write(bytes)
                    else:
                        text = bytes.decode(sys.stdout.encoding, 'strict')
                        sys.stdout.write(text)
                sys.stdout.write("\\n")
                builtins._ = value

            sys.displayhook = displayhook


            class PyConsole(InteractiveConsole):
                def __init__(self):
                    # JQuery.terminal adds a trailing newline that is not easy
                    # to remove with the current API. Doing our best here.
                    def trim(string):
                        return string.rstrip("\\n")

                    super().__init__(
                        stdout_callback=lambda s: js.term.echo(trim(s)),
                        stderr_callback=lambda s: js.term.error(trim(s)),
                        persistent_stream_redirection=False,
                    )

                def runcode(self, code):
                    js.term.pause()
                    resume = lambda *args: js.term.resume()
                    return super().runcode(code).then(resume)

                def banner(self):
                    return f"Welcome to the Pyodide terminal emulator 🐍\\n{super().banner()}"


            js.window.pyconsole = PyConsole()
        `);

        let ps1 = '>>> ', ps2 = '... ';

        function interpreter(command) {
            const prompt = pyconsole.push(command) ? ps2 : ps1;
            term.set_prompt(prompt);
        }

        let term = $('body').terminal(
          interpreter,
          {
            greetings: pyconsole.banner(),
            prompt: ps1
          }
        );

        window.term = term;
      });
    </script>
  </body>
</html>
