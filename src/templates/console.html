<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <script src="https://cdn.jsdelivr.net/npm/jquery"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery.terminal@2.23.0/js/jquery.terminal.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/jquery.terminal@2.23.0/css/jquery.terminal.min.css"
      rel="stylesheet"
    />
    <script src="{{ PYODIDE_BASE_URL }}pyodide.js"></script>
    <style>
      .terminal {
        --size: 1.5;
      }
    </style>
  </head>
  <body>
    <script>
      function sleep(s) {
        return new Promise((resolve) => setTimeout(resolve, s));
      }
      function convert_and_destroy(x) {
        try {
          return x.toJs();
        } finally {
          x.destroy();
        }
      }

      async function main() {
        globalThis.pyodide = await loadPyodide({
          indexURL: "{{ PYODIDE_BASE_URL }}",
        });
        let namespace = pyodide.globals.get("dict")();
        pyodide.runPython(
          `
            import sys
            import js
            from pyodide.console import InteractiveConsole, repr_shorten, BANNER
            import __main__

            class PyConsole(InteractiveConsole):
                def __init__(self):
                    super().__init__(
                        __main__.__dict__,
                        persistent_stream_redirection=False,
                    )


            BANNER = "Welcome to the Pyodide terminal emulator 🐍\\n" + BANNER


            js.pyconsole = PyConsole()
        `,
          namespace
        );
        let repr_shorten = namespace.get("repr_shorten");
        banner = namespace.get("BANNER");
        namespace.destroy();

        let ps1 = ">>> ",
          ps2 = "... ";

        async function lock() {
          let resolve;
          let ready = term.ready;
          term.ready = new Promise((res) => (resolve = res));
          await ready;
          return resolve;
        }

        async function interpreter(command) {
          let unlock = await lock();
          try {
            term.pause();
            // multiline should be splitted (useful when pasting)
            for (const c of command.split("\n")) {
              let [ty, val] = convert_and_destroy(pyconsole.push(c));
              term.set_prompt(ty === "incomplete" ? ps2 : ps1);
              switch (ty) {
                case "syntax-error":
                  term.error(val.trimEnd());
                  continue;
                case "incomplete":
                  continue;
                case "valid":
                  break;
                default:
                  throw new Error(`Unexpected type ${ty}`);
              }
              // Valid case
              try {
                [ty, res] = await val;
                switch (ty) {
                  case "exception":
                    term.error(res.trimEnd());
                    break;
                  case "success":
                    if (res !== undefined) {
                      term.echo(repr_shorten(res));
                    }
                    break;
                  default:
                    throw new Error(`Unexpected type ${ty}`);
                }
              } finally {
                if (pyodide.isPyProxy(res)) {
                  res.destroy();
                }
                val.destroy();
              }
            }
          } finally {
            term.resume();
            await sleep(10);
            unlock();
          }
        }

        let term = $("body").terminal(interpreter, {
          greetings: banner,
          prompt: ps1,
          completionEscape: false,
          completion: function (command, callback) {
            callback(pyconsole.complete(command).toJs()[0]);
          },
        });
        window.term = term;
        pyconsole.stdout_callback = (s) => term.echo(s, { newline: false });
        pyconsole.stderr_callback = (s) => {
          term.error(s.trimEnd());
        };
        term.ready = Promise.resolve();
        pyodide._module.on_fatal = async (e) => {
          term.error(
            "Pyodide has suffered a fatal error. Please report this to the Pyodide maintainers."
          );
          term.error("The cause of the fatal error was:");
          term.error(e);
          term.error("Look in the browser console for more details.");
          await term.ready;
          term.pause();
          await sleep(15);
          term.pause();
        };
      }
      window.console_ready = main();
    </script>
  </body>
</html>
