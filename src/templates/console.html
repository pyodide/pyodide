<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <script src="https://cdn.jsdelivr.net/npm/jquery"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery.terminal@2.23.0/js/jquery.terminal.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/jquery.terminal@2.23.0/css/jquery.terminal.min.css"
      rel="stylesheet"
    />
    <script src="{{ PYODIDE_BASE_URL }}pyodide.js"></script>
    <style>
      .terminal {
        --size: 1.5;
        --color: rgba(255, 255, 255, 0.8);
      }
    </style>
  </head>
  <body>
    <script>
      "use strict";
      function sleep(s) {
        return new Promise((resolve) => setTimeout(resolve, s));
      }

      async function main() {
        globalThis.pyodide = await loadPyodide({
          indexURL: "{{ PYODIDE_BASE_URL }}",
        });
        let namespace = pyodide.globals.get("dict")();
        pyodide.runPython(
          `
          import sys
          from pyodide import to_js
          from pyodide.console import PyodideConsole, repr_shorten, BANNER
          from _pyodide.console import _WriteStream
          import __main__
          from contextlib import redirect_stdout, redirect_stderr
          BANNER = "Welcome to the Pyodide terminal emulator üêç\\n" + BANNER
          pyconsole = PyodideConsole(__main__.__dict__)
          import builtins

          repr_shorten_separator = "\\n[[;orange;]<long output truncated>]\\n"
          def displayhook(value):
            if value is None:
                return
            # Set '_' to None to avoid recursion
            builtins._ = None
            text = repr_shorten(value, separator=repr_shorten_separator)
            try:
              sys.stdout.write(text)
            except UnicodeEncodeError:
              bytes = text.encode(sys.stdout.encoding, 'backslashreplace')
              if hasattr(sys.stdout, 'buffer'):
                sys.stdout.buffer.write(bytes)
              else:
                text = bytes.decode(sys.stdout.encoding, 'strict')
                sys.stdout.write(text)
            sys.stdout.write("\\n")
            builtins._ = value

          def write_stdout(str):
            term.echo(str, newline=False)

          def write_stderr(str):
            term.error(str, newline=False)

          async def print_result(fut):
            try:
              value = await fut
            except BaseException as e:
              with redirect_stderr(_WriteStream(write_stderr)):
                sys.excepthook(type(e), e, e.__traceback__)
                term.echo("");
                return
            if value is not None:
              with redirect_stdout(_WriteStream(write_stdout)):
                sys.displayhook(value)
          def clear_console():
            pyconsole.buffer = []
        `,
          namespace
        );
        let banner = namespace.get("BANNER");
        let print_result = namespace.get("print_result");
        let pyconsole = namespace.get("pyconsole");
        let clear_console = namespace.get("clear_console");

        let ps1 = ">>> ",
          ps2 = "... ";

        async function lock() {
          let resolve;
          let ready = term.ready;
          term.ready = new Promise((res) => (resolve = res));
          await ready;
          return resolve;
        }

        async function interpreter(command) {
          let unlock = await lock();
          term.pause();
          // multiline should be splitted (useful when pasting)
          for (const c of command.split("\n")) {
            let fut = pyconsole.push(c);
            term.set_prompt(fut.syntax_check === "incomplete" ? ps2 : ps1);
            switch (fut.syntax_check) {
              case "syntax-error":
                term.error(fut.formatted_error.trimEnd());
                continue;
              case "incomplete":
                continue;
              case "complete":
                break;
              default:
                throw new Error(`Unexpected type ${ty}`);
            }
            await print_result(fut);
            fut.destroy();
          }
          term.resume();
          await sleep(10);
          unlock();
        }

        let term = $("body").terminal(interpreter, {
          greetings: banner,
          prompt: ps1,
          completionEscape: false,
          completion: function (command, callback) {
            callback(pyconsole.complete(command).toJs()[0]);
          },
          keymap: {
            "CTRL+C": async function (event, original) {
              clear_console();
              term.echo_command();
              term.echo("KeyboardInterrupt");
              term.set_command("");
              term.set_prompt(ps1);
            },
          },
        });
        window.term = term;
        namespace.set("term", term);
        namespace.destroy();
        pyconsole.stdout_callback = (s) => term.echo(s, { newline: false });
        pyconsole.stderr_callback = (s) => {
          term.error(s.trimEnd());
        };
        term.ready = Promise.resolve();
        pyodide._module.on_fatal = async (e) => {
          term.error(
            "Pyodide has suffered a fatal error. Please report this to the Pyodide maintainers."
          );
          term.error("The cause of the fatal error was:");
          term.error(e);
          term.error("Look in the browser console for more details.");
          await term.ready;
          term.pause();
          await sleep(15);
          term.pause();
        };
      }
      window.console_ready = main();
    </script>
  </body>
</html>
