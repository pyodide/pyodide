    <!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <script src="https://code.jquery.com/jquery-latest.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery.terminal/js/jquery.terminal.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/jquery.terminal/css/jquery.terminal.min.css" rel="stylesheet"/>
    <link href="renderedhtml.css" rel="stylesheet"/>
    <script type="text/javascript">
        // set the pyodide files URL (packages.json, pyodide.asm.data etc)
        window.languagePluginUrl = '{{ PYODIDE_BASE_URL }}';
    </script>
    <script src="{{ PYODIDE_BASE_URL }}pyodide.js"></script>
    <style>
      .terminal { --size: 1.5; }
    </style>
  </head>
  <body>
    <script>
      languagePluginLoader.then(() => {
        pyodide.runPython(`
            from pyodide import console
            import js


            class Console(console.InteractiveConsole):
                def runcode(self, code):
                    self.redirect_stdstreams()
                    js.term.pause()
                    js.term.runPython("\\n".join(self.buffer))

                def banner(self):
                    return f"Welcome to the Pyodide terminal emulator ðŸ\\n{super().banner()}"


            # JQuery.terminal add trailing newline that is not easy to remove
            # with the current API. Doing our best here.
            _c = Console(stdout_callback=lambda s: js.term.echo(s.rstrip("\\n")),
                         stderr_callback=lambda s: js.term.error(s.rstrip("\\n")),
                         persistent_stream_redirection=False)
        `)

        let c = pyodide.pyimport('_c');

        function pushCode(line) {
          handleResult(c.push(line));
        }

        let term = $('body').terminal(
          pushCode,
          {
              greetings: c.banner(),
            prompt: "[[;red;]>>> ]"
          }
        );

        window.term = term;

        function handleResult(result) {
          if (result) {
            term.set_prompt('[[;gray;]... ]');
          } else {
<<<<<<< HEAD
            // run some code - await result below because we run async to make imports work
            term.pause()
=======
            term.set_prompt('[[;red;]>>> ]');
>>>>>>> c01ce7415bbb5298dd76f0d53ddc60d9983d1d64
          }
        }

        term.runPython = function(code) {
          pyodide.runPythonAsync(code).then(
            term.handlePythonResult, term.handlePythonError
<<<<<<< HEAD
          )
        }

        function showIO()
        {
            term.resume()
            term.set_prompt('[[;red;]>>> ]')
            var stderr = pyodide.runPython("sys.stderr.getvalue()").trim()
            if (stderr) {
              term.echo(`[[;red;]${stderr}]`)
            } else {
              var stdout = pyodide.runPython("sys.stdout.getvalue()")
              if (stdout) {
                term.echo(stdout.trim())
              }
            }
        }

        term.handlePythonResult = function(result) {
          showIO();
=======
          );
        };

        term.handlePythonResult = function(result) {
          c.restore_stdstreams();
          term.resume();
>>>>>>> c01ce7415bbb5298dd76f0d53ddc60d9983d1d64
          if (result === undefined) {
            return;
          } else if (result['_repr_html_'] !== undefined) {
            term.echo(result['_repr_html_'], {raw: true});
          } else {
            term.echo(result.toString());
          }
        };

        term.handlePythonError = function(result) {
<<<<<<< HEAD
          showIO();
          term.error(result.toString())
=======
          c.restore_stdstreams();
          term.resume();
          term.error(result.toString());
>>>>>>> c01ce7415bbb5298dd76f0d53ddc60d9983d1d64
        }
      });
    </script>
  </body>
</html>
